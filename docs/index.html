<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>BELOURA • Ingreso de Envíos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0f172a; color:#e2e8f0; margin:0; }
    .wrap { max-width: 860px; margin: 32px auto; padding: 0 16px; }
    .card { background:#111827; border:1px solid #334155; border-radius:16px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    h1 { font-size: 24px; margin: 0 0 8px; }
    p.muted { color:#94a3b8; margin-top:0 }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 760px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; outline: none; }
    label { font-size: 13px; color:#cbd5e1; margin-bottom:6px; display:block; }
    .row { margin-bottom: 10px; }
    .btn { padding: 12px; border:0; border-radius: 12px; font-weight: 700; cursor: pointer; }
    .btn-primary { background:#2dd4bf; color:#0b1220; }
    .btn-secondary { background:#334155; color:#e2e8f0; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .alert { margin-top:12px; padding:12px; border-radius: 12px; }
    .alert-error { background:#7f1d1d; color:#fecaca; border:1px solid #fecaca33; }
    .alert-ok { background:#064e3b; color:#bbf7d0; border:1px solid #bbf7d033; }
    .note { color:#94a3b8; font-size: 12px; margin-top:6px; }
    .actions { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media (min-width: 760px) { .actions { grid-template-columns: 1fr 1fr; } }
    a.link { color:#a7f3d0; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BELOURA • Ingreso de Envíos</h1>
    <p class="muted">Formulario simple con código corto y factura PDF automática en Google Drive.</p>

    <div class="card">
      <form id="envioForm">
        <h3>Remitente</h3>
        <div class="grid grid-2">
          <div class="row">
            <label>Nombre *</label>
            <input required name="remitente_nombre" placeholder="Ej: Juan Pérez" />
          </div>
          <div class="row">
            <label>Teléfono *</label>
            <input required name="remitente_telefono" placeholder="Ej: +1 555 123 4567" />
          </div>
          <div class="row" style="grid-column: 1 / -1;">
            <label>Dirección *</label>
            <input required name="remitente_direccion" placeholder="Ej: 123 Main St, Arlington, TX" />
          </div>
        </div>

        <h3 style="margin-top:14px">Destinatario</h3>
        <div class="grid grid-2">
          <div class="row">
            <label>Nombre *</label>
            <input required name="destinatario_nombre" placeholder="Ej: Pedro Gómez" />
          </div>
          <div class="row">
            <label>Cédula *</label>
            <input required name="destinatario_cedula" placeholder="Ej: 0912345678" />
          </div>
          <div class="row" style="grid-column: 1 / -1;">
            <label>Dirección *</label>
            <input required name="destinatario_direccion" placeholder="Ej: Calle 1 y Av. 2, Babahoyo" />
          </div>
          <div class="row">
            <label>Teléfono *</label>
            <input required name="destinatario_telefono" placeholder="Ej: 099 123 4567" />
          </div>
        </div>

        <h3 style="margin-top:14px">Envío</h3>
        <div class="grid grid-2">
          <div class="row" style="grid-column: 1 / -1;">
            <label>Detalle (contenido) *</label>
            <input required name="detalle_envio" placeholder="Ej: Perfumes y ropa" />
          </div>
          <div class="row">
            <label>Valor estimado (USD) *</label>
            <input required name="valor_estimado" inputmode="decimal" placeholder="Ej: 120.50" />
          </div>
          <div class="row">
            <label>Peso (lb) *</label>
            <input required name="peso_lb" inputmode="decimal" value="8.00" />
          </div>
          <div class="row">
            <label>Estado inicial *</label>
            <select name="estado_inicial">
              <option>Recibido en Arlington</option>
              <option>En tránsito a Miami</option>
              <option>Recibido en Miami</option>
              <option>En vuelo a Ecuador</option>
              <option>En aduana (EC)</option>
              <option>En ruta a ciudad destino</option>
              <option>Entregado</option>
            </select>
          </div>
          <div class="row" style="grid-column: 1 / -1;">
            <label>Observación (opcional)</label>
            <textarea name="observacion" rows="3" placeholder="Notas internas, instrucciones especiales, etc."></textarea>
          </div>
          <div class="row" style="grid-column: 1 / -1; display:flex; gap:8px; align-items:center;">
            <input type="checkbox" id="consolidado" name="consolidado" checked />
            <label for="consolidado" style="margin:0">Ocultar nombres en rastreo público (consolidado)</label>
          </div>
        </div>

        <div id="msg" class="alert" style="display:none"></div>

        <div class="actions" style="margin-top:12px">
          <button class="btn btn-primary" type="submit" id="btnCrear">Crear envío (Sheets + PDF)</button>
          <button class="btn btn-secondary" type="button" id="btnFactura">Generar factura (solo PDF)</button>
        </div>
        <div class="note">Se generará un código de tracking corto (ej. <b>BLRA456</b>) y un PDF en Google Drive con enlace público.</div>
      </form>
    </div>
  </div>

  <script>
    // ⛳️ Pega aquí tu URL de Web App de Apps Script (termina en /exec)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzZr1iPVRwL3WI0xq-SBhNS0UktBs6YZSDHjPDvUl8OsLkeEt1wu0KiO-rxQx5uecYJKA/exec";

    const form = document.getElementById('envioForm');
    const btnCrear = document.getElementById('btnCrear');
    const btnFactura = document.getElementById('btnFactura');
    const msg = document.getElementById('msg');

    function collectForm() {
      const fd = new FormData(form);
      const obj = {};
      fd.forEach((v, k) => obj[k] = (typeof v === 'string' ? v.trim() : v));
      obj.consolidado = document.getElementById('consolidado').checked;
      return obj;
    }

    function showMsg(text, ok=false) {
      msg.style.display = 'block';
      msg.className = 'alert ' + (ok ? 'alert-ok' : 'alert-error');
      msg.innerHTML = text;
    }

    async function callBackend(action, payload, code) {
      const res = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, payload, code })
      });
      return await res.json();
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        btnCrear.disabled = true;
        showMsg('Guardando envío...', true);
        const payload = collectForm();

        // Validaciones mínimas numéricas
        if (isNaN(Number(payload.valor_estimado))) throw new Error('Valor estimado inválido');
        if (isNaN(Number(payload.peso_lb))) throw new Error('Peso inválido');

        const data = await callBackend('create', payload);
        if (!data.ok) throw new Error(data.error || 'Error al crear envío');
        showMsg(`✅ Envío creado. Código: <b>${data.code}</b> · <a class="link" href="${data.pdfUrl}" target="_blank">Abrir PDF</a>`, true);
      } catch (err) {
        showMsg('❌ ' + err.message);
      } finally {
        btnCrear.disabled = false;
      }
    });

    btnFactura.addEventListener('click', async () => {
      try {
        btnFactura.disabled = true;
        showMsg('Generando factura...', true);
        const payload = collectForm();

        if (isNaN(Number(payload.valor_estimado))) throw new Error('Valor estimado inválido');
        if (isNaN(Number(payload.peso_lb))) throw new Error('Peso inválido');

        const data = await callBackend('invoice', payload);
        if (!data.ok) throw new Error(data.error || 'No se pudo generar la factura');
        showMsg(`✅ Factura generada. Código: <b>${data.code}</b> · <a class="link" href="${data.pdfUrl}" target="_blank">Abrir PDF</a>`, true);
        window.open(data.pdfUrl, '_blank');
      } catch (err) {
        showMsg('❌ ' + err.message);
      } finally {
        btnFactura.disabled = false;
      }
    });
  </script>
</body>
</html>
