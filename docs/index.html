<script>
  // URL de tu WebApp (la misma que usas en el panel)
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxW8kOXtVj_cLrdt2GY1uyMmlYAN2vb1LZR9QAoJKEHSJAYYaN7a-COUujLS2JsNhc0zQ/exec";

  const form       = document.getElementById('envioForm');
  const msg        = document.getElementById('msg');
  const btnCrear   = document.getElementById('btnCrear');
  const btnFactura = document.getElementById('btnFactura');

  function show(text, ok=false){
    msg.style.display = 'block';
    msg.className = 'alert ' + (ok ? 'ok' : 'err');
    msg.innerHTML = text;
  }

  function collect(){
    const fd = new FormData(form); 
    const o = {};
    fd.forEach((v,k)=>o[k]=String(v||'').trim());
    o.consolidado = document.getElementById('consolidado').checked;
    if (isNaN(Number(o.valor_estimado))) throw new Error('Valor estimado inv√°lido');
    if (isNaN(Number(o.peso_lb)))       throw new Error('Peso inv√°lido');
    return o;
  }

  const toQS = o => new URLSearchParams(o).toString();

  async function apiPost(body={}){
    const r = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: toQS(body)
    });
    try {
      return await r.json();
    } catch(e) {
      console.error(e);
      return { ok:false, error:'bad_json' };
    }
  }

  // ---- Crear env√≠o (Sheets + PDF) ----
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    try{
      btnCrear.disabled = true;
      show('Guardando‚Ä¶', true);

      const p = collect();

      const body = {
        path: 'api/envios/create',

        // Remitente
        remitente_nombre:    p.remitente_nombre,
        remitente_telefono:  p.remitente_telefono,
        remitente_direccion: p.remitente_direccion,

        // Destinatario (mapeo a nombres que espera Apps Script)
        dest_nombre:    p.destinatario_nombre,
        dest_cedula:    p.destinatario_cedula,
        dest_direccion: p.destinatario_direccion,
        dest_telefono:  p.destinatario_telefono,

        // Detalles del env√≠o
        detalle:        p.detalle_envio,
        valor_estimado: p.valor_estimado,
        peso_lb:        p.peso_lb,
        observacion:    p.observacion || '',
        consolidado:    p.consolidado ? 'S√≠' : '',
        estado_inicial: p.estado_inicial || ''
        // Si alg√∫n d√≠a usas cliente_code, aqu√≠ se a√±ade:
        // cliente_code: 'BLR-XXXX'
      };

      const data = await apiPost(body);
      console.log('RESPUESTA ENV√çO:', data);

      if(!data.ok) throw new Error(data.error || 'Error al crear env√≠o');

      // üëá OJO: ahora usamos data.codigo y data.pdfUrl (como devuelve tu Apps Script)
      show(
        `‚úÖ Env√≠o creado. C√≥digo: <b>${data.codigo}</b> ¬∑ ` +
        `<a class="link" href="${data.pdfUrl}" target="_blank">Abrir PDF</a>`,
        true
      );

      // Abrir el PDF en nueva pesta√±a
      if (data.pdfUrl) {
        window.open(data.pdfUrl, '_blank');
      }
    }catch(err){
      console.error(err);
      show('‚ùå '+err.message);
    }finally{
      btnCrear.disabled = false;
    }
  });

  // ---- Generar factura (solo PDF) ----
  // Por ahora, usamos el mismo endpoint: tambi√©n guarda el env√≠o en Sheets
  // Si quisieras que NO guarde en Sheets, habr√≠a que crear otra ruta en Apps Script.
  btnFactura.addEventListener('click', async ()=>{
    try{
      btnFactura.disabled = true;
      show('Generando factura‚Ä¶', true);

      const p = collect();

      const body = {
        path: 'api/envios/create',

        remitente_nombre:    p.remitente_nombre,
        remitente_telefono:  p.remitente_telefono,
        remitente_direccion: p.remitente_direccion,

        dest_nombre:    p.destinatario_nombre,
        dest_cedula:    p.destinatario_cedula,
        dest_direccion: p.destinatario_direccion,
        dest_telefono:  p.destinatario_telefono,

        detalle:        p.detalle_envio,
        valor_estimado: p.valor_estimado,
        peso_lb:        p.peso_lb,
        observacion:    p.observacion || '',
        consolidado:    p.consolidado ? 'S√≠' : '',
        estado_inicial: p.estado_inicial || ''
      };

      const data = await apiPost(body);
      console.log('RESPUESTA FACTURA:', data);

      if(!data.ok) throw new Error(data.error || 'No se pudo generar la factura');

      show(
        `‚úÖ Factura generada y env√≠o registrado. C√≥digo: <b>${data.codigo}</b> ¬∑ ` +
        `<a class="link" href="${data.pdfUrl}" target="_blank">Abrir PDF</a>`,
        true
      );

      if (data.pdfUrl) {
        window.open(data.pdfUrl, '_blank');
      }
    }catch(err){
      console.error(err);
      show('‚ùå '+err.message);
    }finally{
      btnFactura.disabled = false;
    }
  });
</script>
